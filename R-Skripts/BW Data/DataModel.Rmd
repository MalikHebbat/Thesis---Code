---
title: "Data & Model"
output: html_notebook
author: "Malik Hebbat"
---

Load the packages and dataset and get started.

```{r}
library(tidyverse)
library(lubridate)
library(readxl)
library(Hmisc)
library(mice)
library(plm)

load("/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/Data Sets/BetterWorksClustered.RData")

```

Here we load the "FGW" Question and make them variables

```{r}

data$Q.Label <- gsub("\r\n","",data$Q.Label)

cat_document <- read_excel('/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/cycle-trend-panel-creation-main/2022-02-01_All CAT questions with with Global Identifiers and all Tags.xlsx')%>%
  group_by(country_name, cluster_name, compliance_point_name,first_original_question_id,question_id,
           text,finding,question_type,global_question_mapping_id,global_text,global_finding)%>%
  summarise(n=n())%>%
  select(-n)

unique(cat_document$text[str_detect(cat_document$text ,"refuse to bargain")])




refBarg<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label== "Does the employer refuse to bargain collectively or refuse to bargain in good faith with the union, worker representatives, union federations or confederations?"   |                                  
Q.Label==  "Does the employer refuse to bargain collectively or refuse to bargain in good faith with the union, shop stewards, union federations or confederations?"       |                                       
 Q.Label==  "Does the employer refuse to bargain collectively or refuse to bargain in good faith with the union or worker representatives?"     |                                                                   
 Q.Label==  "Does the employer refuse to bargain collectively with union federations and confederations?"                       |                                                                                   
 Q.Label==  "Does the employer refuse to bargain collectively or refuse to bargain in good faith with the union(s)?"                            |                                                                   
 Q.Label==  "Does the employer refuse to bargain collectively or refuse to bargain in good faith with the union?"                                       |                                                           
 Q.Label==  "Does the employer refuse to bargain collectively or refuse to bargain in good faith with the union,  worker representatives, union federations or confederations?"    |                                
 Q.Label== "Does the employer refuse to bargain collectively or refuse to bargain in good faith with the union or provisional union?"                                    |                                         
 Q.Label==  "Does the employer refuse to bargain collectively in accordance with legal requirements, or refuse to bargain in good faith with the union or provisional union?"  |                                    
Q.Label==  "Does the employer refuse to bargain collectively in accordance with legal requirements, or refuse to bargain in good faith with the union, workers representation, union federation or confederation?")%>%

  rename("refBarg"=Finding)

unique(cat_document$text[str_detect(cat_document$text ,"freely form and join")])

formUnion<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Can workers freely form and join the union of their choice?"    |                       
Q.Label== "Can workers freely form and join a union?"                |                             
Q.Label== "Can the union(s) freely form and join federations and confederations of their choice?" |
Q.Label== "Can workers freely form and join the union of their choice? [differentiation question]"|
Q.Label== "Can workers freely form and join the union of their choice? *"          |               
Q.Label== "Can workers freely form and join the union of their choice ?" )%>%
  rename("formUnion"=Finding)

unique(cat_document$text[str_detect(cat_document$text ,"punish workers")])


punUnion<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Does the employer punish workers for joining a union or engaging in union activities?"                           |
Q.Label== "Does the employer punish workers for joining a union or engaging in union activities? [differentiation question]"|
Q.Label== "Does the employer punish workers for joining a union or engaging in union activities? *"|                         
Q.Label== "Does the employer punish workers for joining a union or engaging in union activities ?")%>%
  rename("punUnion"=Finding)

unique(cat_document$text[str_detect(cat_document$text ,"percentage of workers")])


percUnion<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="What percentage of workers are union members?")%>%
  rename("percUnion"=Finding)



unique(cat_document$text[str_detect(cat_document$text ,"have access to the workers")])


accessUnion<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Do union representatives have access to the workers in the workplace?")%>%
  rename("AccessUnion"=Finding)

unique(cat_document$text[str_detect(cat_document$text ,"collective bargaining agreements")])


NummBarg<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="How many collective bargaining agreements are in effect in the factory?" )%>%
  rename("NumBarg"=Finding)


unique(cat_document$text[str_detect(cat_document$text ,"PICC")])

PICC<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Did workers freely choose their representatives on the bipartite committee (PICC), and do workers know who their representatives are?" |
        Q.Label=="Did workers freely choose their representatives on the bipartite committee (PICC), and do workers know who their representatives are? [pre-stage 2 question]" |
        Q.Label=="Did workers freely choose their representatives on the PICC, and do workers know who their representatives are? [pre-stage 2 question]")%>%
  rename("Picc"=Finding)


unique(cat_document$text[str_detect(cat_document$text ,"training")])

trainGen<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label== "Is the gender of a worker a factor in decisions regarding opportunities for promotion or access to training?"   |                                                                       Q.Label== "Is the gender or marital status of a worker a factor in decisions regarding opportunities for promotion or access to training?")%>%
  rename("trainGen"=Finding)


unique(cat_document$text[str_detect(cat_document$text ,"chemicals")])

trainChem<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Has the employer effectively trained workers who work with chemicals and hazardous substances?" |
          Q.Label=="Has the employer effectively trained workers and supervisor who work with or are responsible for chemicals and hazardous substances?" |
          Q.Label=="Has the employer effectively trained workers and supervisor who work with or are responsible for hazardous chemicals?"|
          Q.Label== "Has the employer effectively trained workers and supervisors who work with or are responsible for hazardous chemicals?")%>%
  rename("trainChem"=Finding)


unique(cat_document$text[str_detect(cat_document$text ,"first-aid")])


trainFirst<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Has the employer provided first-aid training for workers?" |
         Q.Label==  "Has the employer trained workers on first aid and formed a first-aid team?" |
         Q.Label==  "Has the employer provided rescue and first-aid training for workers?")%>%
  rename("trainFirst"=Finding)

unique(cat_document$text[str_detect(cat_document$text ,"under age 18")])


trainu16<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Are all workers who are under age 18 and doing hazardous work (i) at least 16 years old; (ii) working in accordance with Jordanian law; (iii) working in such a way that their health, safety and morals are fully protected; and (iv) adequately trained to do the work safely?"| 
           Q.Label=="Are there any workers under age 18 who are doing hazardous work and who are (i) under 16 years old; (ii) working more than 7 hours/day or 42 hours/week; (vi) working overtime or at night; (iii) working in such a way that their health, safety and morals are not fully protected; or (iv) not adequately trained to do the work safely?"|
           Q.Label=="Are all workers who are under age 15 working (a) in accordance with national regulations regarding light work or (b) in a government-approved training program?" 
         )%>%
  rename("trainu16"=Finding)

# unique(cat_document$text[str_detect(cat_document$text ,"How many vocational")& (cat_document$country_name=="Jordan")])
# unique(cat_document$text[str_detect(cat_document$text ,"vocational")& (cat_document$country_name=="Indonesia")])
# unique(cat_document$text[str_detect(cat_document$text ,"vocational")& (cat_document$country_name=="Vietnam")])
# 
# 
# trainVoc<- data%>%
#   select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
#   group_by(Country,Factory.Assessed.ID,Cycle)%>%
#   filter(Q.Label=="How many vocational trainees are employed by the factory?" 
#          & (Country=="Indonesia" | Country=="Jordan" | Country=="Vietnam"))%>%
#   rename("trainVoc"=Finding)


unique(cat_document$text[str_detect(cat_document$text ,"training workers")])


trainWorker<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="How many training workers are employed by the factory?")%>%
  rename("trainWorker"=Finding)

trainMen<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="How many of the training workers are men?" 
         )%>%
  rename("trainMen"=Finding)

# trainVocMen<- data%>%
#   select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
#   group_by(Country,Factory.Assessed.ID,Cycle)%>%
#   filter(Q.Label=="How many of the vocational trainees are men?" 
#          & (Country=="Indonesia" | Country=="Jordan" | Country=="Vietnam"))%>%
#   rename("trainVocMen"=Finding)


unique(cat_document$text[str_detect(cat_document$text ,"apprentice")])

trainAppr<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="How many training/apprentice workers are employed by the factory?" |
           Q.Label=="How many apprentices are employed by the factory in production?" |
           Q.Label=="How many apprentices are training in the factory?" |
           Q.Label=="How many apprentices are employed by the factory?")%>%
  rename("trainAppr"=Finding)

trainApprMen<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="How many training/apprentice workers are men?" |
           Q.Label=="How many of the apprentices in production are men?"|
         Q.Label=="How many of the apprentices workers are men?" |
           Q.Label=="How many of the apprentices are men?"
         )%>%
  rename("trainApprMen"=Finding)

# trainOSH<- data%>%
#   select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
#   group_by(Country,Factory.Assessed.ID,Cycle)%>%
#   filter(Q.Label=="Are workers effectively trained on occupational health and safety?" 
#          & (Country=="Indonesia" | Country=="Jordan" | Country=="Vietnam"))%>%
#   rename("trainOSH3"=Finding)

unique(cat_document$text[str_detect(cat_document$text ,"minimum wage")])

minimumWage<- data%>%
  select(Country,Cycle,Year,Factory.Assessed.ID,Q.Label,Question.ID,Finding)%>%
  group_by(Country,Factory.Assessed.ID,Cycle)%>%
  filter(Q.Label=="Does the employer pay the correct district minimum wage for ordinary hours of work to permanent full time workers (PKWTT) ?" |
           Q.Label=="Does the employer pay at least minimum wage for ordinary hours of work to regular full time workers?"|
         Q.Label=="Does the employer pay at least the applicable legal minimum wage for ordinary hours of work to regular full time workers?")%>%
  rename("tminWage"=Finding)


```

Now we get the factories aranged and build the base dataset

```{r}

temp_func <- function(data) {
  latest_date_for_each_factory <- data %>%
    group_by( Cluster,Country,Factory.Assessed.ID,Factory.Assessed.Name,Cycle,Year)%>%
    summarise(Quest.ID = max(Quest.ID))
  temp_df <- inner_join(data,latest_date_for_each_factory,
                        by = c('Cluster','Country',"Factory.Assessed.ID",'Factory.Assessed.Name','Cycle','Quest.ID','Year'))
  temp_df <- temp_df[temp_df$Question.type != "FGW",]
  temp_df$Finding <- as.integer(temp_df$Finding)
  compliance_calc <- temp_df%>%
    group_by(Cluster,Country,Factory.Assessed.ID,Factory.Assessed.Name, Cycle, Year,Quest.ID,CP)%>%
    summarise(findings = sum(Finding))
  compliance_calc$non_compliant <-ifelse(compliance_calc$findings >0,1,0)
  compliance_df <- compliance_calc%>%
    group_by(Cluster,Country,Factory.Assessed.ID,Factory.Assessed.Name,Cycle,Year,CP)%>%
    summarise(total_factories=n(),number_non_compliant= sum(non_compliant), percent_non_cp = sum(non_compliant)/n())
  factory_level_average_nc <- compliance_df%>%
    group_by(Cluster,Country,Factory.Assessed.ID,Factory.Assessed.Name,Cycle,Year)%>%
    summarise(total_cp_nc = sum(number_non_compliant), total_cps = n(), factory_cp_level_nc_rate = sum(number_non_compliant)/n())
}

cps2<- list()
for (i in 1:length(Cl)) {
  cps2[[i]] <-  temp_func(Cl[[i]])
}

cps2_all <- bind_rows(cps2)

end_period_2021 <- as.Date("31/12/2021","%d/%m/%Y")
all_factories_ever_in_programme <- read_excel('/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/cycle-trend-panel-creation-main/Enterprise_Report_All_01-02-2022.xlsx', skip = 1)%>%
  rename(Creation..Data = `Creation  Data`)%>%
   rename(Country = Country...11)%>%
   mutate(ID = as.integer(ID))%>%
   filter(Status %in% 'Active')%>%
  filter(as.Date(Creation..Data,"%d/%m/%Y") <= end_period_2021)
all_factories_ever_in_programme <- all_factories_ever_in_programme %>%
  rename("Factory.Assessed.Name"=Name)

cpsx <- left_join(cps2_all,all_factories_ever_in_programme,by=c('Country',"Factory.Assessed.Name"))

cpsx <- cpsx %>% arrange(Cluster,Country,Factory.Assessed.ID) 

cpsx <- cpsx %>%
  
  left_join(.,refBarg[,c("Factory.Assessed.ID","Country","Cycle","Year","refBarg")],
              by=c('Cycle','Country','Year',"Factory.Assessed.ID")) %>%
  
  
  left_join(.,formUnion[,c("Country","Cycle","Year","Factory.Assessed.ID","formUnion")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID")) %>%
  
  left_join(.,accessUnion[,c("Country","Cycle","Year","Factory.Assessed.ID","AccessUnion")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%

  left_join(.,NummBarg[,c("Country","Cycle","Year","Factory.Assessed.ID","NumBarg")],
                  by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
        
        left_join(.,minimumWage[,c("Country","Cycle","Year","Factory.Assessed.ID","tminWage")],
                  by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
        
        
  
  left_join(.,punUnion[,c("Country","Cycle","Year","Factory.Assessed.ID","punUnion")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  left_join(.,percUnion[,c("Country","Cycle","Year","Factory.Assessed.ID","percUnion")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  left_join(.,trainAppr[,c("Country","Cycle","Year","Factory.Assessed.ID","trainAppr")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  left_join(.,trainApprMen[,c("Country","Cycle","Year","Factory.Assessed.ID","trainApprMen")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  left_join(.,trainChem[,c("Country","Cycle","Year","Factory.Assessed.ID","trainChem")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  left_join(.,trainFirst[,c("Country","Cycle","Year","Factory.Assessed.ID","trainFirst")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  left_join(.,trainGen[,c("Country","Cycle","Year","Factory.Assessed.ID","trainGen")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  
  left_join(.,trainMen[,c("Country","Cycle","Year","Factory.Assessed.ID","trainMen")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  
  left_join(.,trainu16[,c("Country","Cycle","Year","Factory.Assessed.ID","trainu16")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))%>%
  
  left_join(.,trainWorker[,c("Country","Cycle","Year","Factory.Assessed.ID","trainWorker")],
            by=c('Cycle','Country','Year',"Factory.Assessed.ID"))


cpsx <- cpsx[!is.na(cpsx$ID),]
```

We add the supplementary data

```{r}
load("/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/Data Sets/supplementaryConflictWIDHSEDU.RDATA")


happy_ind <- happy_ind%>%
  rename(Year=year)
cpsx <- cpsx %>%
  
left_join(.,happy_ind,
            by=c('Country','Year'))

counts_confl <- counts_confl%>%
  rename(Year=year,
         Country=country,
         counts_conflict=rowCount)

cpsx <- cpsx %>%
  
  left_join(.,counts_confl,
            by=c('Country','Year'))
counts_air <- counts_air%>%
  rename(
         Country=country,
         counts_air=rowCount)

cpsx <- cpsx %>%
  
  left_join(.,counts_air,
            by=c('Country'))

cpsx <- cpsx[!is.na(cpsx$ID),]
save(cpsx,file="/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/Data Sets/rawData.RData")
```


Now we go to get the dataset in shape. We format and build new variables


```{r}


rem <- c("Original Factory ID",
         "Address 1",
         "Address 2...7",
         "City...8",
         "State",
         "Contact Name...12",
         "Office Telephone Number",
         "Fax Number",
         "Email",
         "GPS Coordinates X",
         "GPS Coordinates Y",
         "Full legal name of the enterprise that owns the supplier",
         "Address",
         "Address 2...21",
         "City...22",
         "Country...23",
         "Contact Name...24",
         "Second Product",
         "Customer 1 - Name",
         "Customer 1 - Length of Business Relationship",
         "Customer 2 - Name",
         "Customer 2 - Length of Business Relationship",
         "Customer 2 - Preferred Supplier",
         "Customer 2 - Contractor",
         "Customer 2 - Subcontractor",
         "Customer 3 - Name",
         "Customer 3 - Length of Business Relationship",
         "Customer 3 - Preferred Supplier",
         "Customer 3 - Contractor",
         "Customer 3 - Subcontractor",
         "Obsoletion Reason",
         "Assigned Advisor")
cpsxc <- cpsx[!(names(cpsx) %in% rem)]

cpsxc$NumBarg <- readr::parse_number(cpsxc$NumBarg)


cpsxc$percUnion <-  readr::parse_number(cpsx$percUnion)/100
cpsxc$percUnion <-  ifelse(cpsxc$percUnion>1,cpsxc$percUnion/10,cpsxc$percUnion)

cpsxc$firm_age <- ifelse(as.numeric(cpsxc$`In what year did this supplier begin operations in this country?`)>0,
                                    cpsxc$Year-as.numeric(cpsxc$`In what year did this supplier begin operations in this country?`),
                                                    1)
cpsxc$`In what year did this supplier begin operations in this country?` <- NULL

cpsxc <- cpsxc%>%
  rename("firm_size"=Total)%>%
  mutate(firm_size=as.numeric(firm_size),
         Female=as.numeric(Female),
         Male=as.numeric(Male))

cpsxc$femRatio <- (cpsxc$Female/cpsxc$firm_size)*100


cpsxc$prefSup <- ifelse(cpsxc$`Customer 1 - Preferred Supplier`=="Yes",1,0)
cpsxc$contr <- ifelse(cpsxc$`Customer 1 - Contractor`=="Yes",1,0)
cpsxc$subContr <- ifelse(cpsxc$`Customer 1 - Subcontractor`=="Yes",1,0)

cpsxc$`Customer 1 - Preferred Supplier` <- cpsxc$`Customer 1 - Contractor` <-cpsxc$`Customer 1 - Subcontractor` <- NULL 


#cpsxc <- cpsxc[cpsxc$Year!=2022 & cpsxc$Year!=2009 & cpsxc$Year!=2010,]


# meanCountry <- aggregate(cpsxc$factory_cp_level_nc_rate,by=list(cpsxc$Country,cpsxc$Year),mean)%>%
#   rename(Country=Group.1,
#          Year=Group.2,
#          mean_cp_level_nc_rate_country=x)
# 
# meanFirm <- aggregate(cpsxc$factory_cp_level_nc_rate,by=list(cpsxc$Cluster,cpsxc$Factory.Assessed.ID),mean)%>%
#   rename(Cluster=Group.1,
#          Firm=Group.2,
#          mean_cp_level_nc_rate_country=x)
# 
# cpsxc <- left_join(cpsxc,meanCountry,by=c("Country", "Year"))



# Output <- cpsxc %>% 
#   group_by(Cluster,Country,Factory.Assessed.ID,Cycle) %>% 
#   summarise(Value = mean(factory_cp_level_nc_rate,na.rm=T)) %>% # ensure only 1 Value per Cycle/Factory ID
#   mutate(PrevValue = Lag(Value, shift=1), # create column that is previous cycle value                            
#          DiffToPrevCycle = PrevValue - Value)
# 
# cpsxc <- left_join(cpsxc,Output,by=c("Country","Cluster","Cycle" , "Factory.Assessed.ID"))
cpsxc$Creation..Data <- as.Date(cpsxc$Creation..Data,"%d/%m/%Y")
cpsxc$lenPart <- cpsxc$Year-lubridate::year(cpsxc$Creation..Data) 


names(cpsxc) <- make.names(names(cpsxc))
cpsxc <- cpsxc%>%
  mutate(
    formUnion=as.factor(formUnion),
    refBarg=as.factor(refBarg),
         AccessUnion=as.factor(AccessUnion),
         punUnion=as.factor(punUnion),
         trainFirst=as.factor(trainFirst),
         trainChem=as.factor(trainChem),
         trainGen=as.factor(trainGen),
         trainu16=as.factor(trainu16),
         trainAppr=as.numeric(trainAppr),
         trainApprMen=as.numeric(trainApprMen),
         trainMen=as.numeric(trainMen),
         tminWage=as.numeric(tminWage),
        Peer.Grouping.Enabled = as.factor(ifelse(Peer.Grouping.Enabled=="No",1,0)),
         Cluster = as.factor(Cluster),
         Factory.Assessed.ID = as.numeric(Factory.Assessed.ID),
         factory_cp_level_nc_rate = as.numeric(factory_cp_level_nc_rate),
         total_cp_nc = as.numeric(total_cp_nc),
         total_cps = as.numeric(total_cps),
         trainWorker =as.numeric(trainWorker)
  )


cpsxc$Creation..Data <- NULL
cpsxc$Country.Code..Alpha.2. <- NULL
cpsxc$Year <- NULL
cpsxc$Zip.Code <- NULL

x <-  pdata.frame(cpsxc,index = c("Country" ,"Factory.Assessed.ID","Cycle"))
pdata <- unique(x, by = c("Country","Cluster","Factory.Assessed.ID","Cycle"))

pdata <- as.data.frame(pdata)
save(pdata,file="/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/Data Sets/rawshapedData.RData")
```


Imputation takes place

```{r}
#tempData <- mice(pdata,m=5,method="rf",maxit=5,cluster.seed=500)
load("/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/Data Sets/impData.RData")
rem_imp <- c("Factory.Assessed.Name","Zip.Code", 
                       "Datasets","Section", "Division" ,
                         "Latest.Cycle", "Cycle.Start.Date","ID",  "Status", "ISO", "Continent"," Country.Code..Alpha.2.")
pdata<- pdata[,!names(pdata) %in% rem_imp]
pdata$Factory.Assessed.ID <- as.numeric(as.character(pdata$Factory.Assessed.ID))
pdata$First.Product <- NULL
pdata$Country <- as.factor(pdata$Country)

library(missForest)
set.seed(500)
tempDataForest<- missForest(pdata,maxiter=5,ntree=100,verbose=T)
tempDataForest$OOBerror

save(tempDataForest,file="/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/Data Sets/impData.RData")
```
Now we create the first base model.

feel free to play around!


```{r}
library(sjstats)
library(fixest)
tempDataForest$ximp$NumBarg <- round(tempDataForest$ximp$NumBarg)
#tempDataForest$ximp$tminWage <- as.factor(ifelse(tempDataForest$ximp$tminWage<0.5,0,1))


summary(fit.1 <- fepois(factory_cp_level_nc_rate ~ Peer.Grouping.Enabled+firm_age + lenPart+firm_size+
         percUnion + prefSup+femRatio+trainChem+trainFirst+
         NumBarg+formUnion+
         refBarg|Cycle+Cluster+Country, tempDataForest$ximp))



fit.1

```

prue a few trees to get nodes

```{r}

library(rpart)
library(rpart.plot)
library(rattle)
load("/Users/malik/Dropbox (GALILEO)/Master Thesis/RManual-master/Data Sets/impData.RData")

rem1 <- c("total_cps","total_cp_nc","HPI_rank","trainGen")
temp <- tempDataForest$ximp[,!names(tempDataForest$ximp) %in% rem1]

#pruned for splitting by cluster
CL <- split(temp,temp$Cluster)
bw_tree=list()
bw_tree2_prune <- list()
for( name in names(CL)) {
  set.seed(501)
  bw_tree[[name]] <- rpart(factory_cp_level_nc_rate~.,data=CL[[name]])
  
  bw_tree2_prune[[name]] <- prune(bw_tree[[name]],cp=     bw_tree[[name]]$cptable[which.min(bw_tree[[name]]$cptable[,"xerror"]),"CP"])
  
  
}


bw_tree

fancyRpartPlot(bw_tree2_prune[[1]])
fancyRpartPlot(bw_tree2_prune[[2]])
fancyRpartPlot(bw_tree2_prune[[3]])


#pruned for splitting by country
ctry <-  split(temp,temp$Country)

 
bw_tree1=list()
bw_tree1_prune <- list()
for( name in names(ctry)) {
  set.eed(501)
  bw_tree1[[name]] <- rpart(factory_cp_level_nc_rate~.,data=ctry[[name]])
  
  bw_tree1_prune[[name]] <- prune(bw_tree1[[name]],cp=     bw_tree1[[name]]$cptable[which.min(bw_tree1[[name]]$cptable[,"xerror"]),"CP"])
  
  
}
 

bw_tree1
fancyRpartPlot(bw_tree1_prune[[1]])
fancyRpartPlot(bw_tree1_prune[[2]])
fancyRpartPlot(bw_tree1_prune[[3]])


#pruned for splitting by cycle

cycles <-  split(temp,temp$Cycle)

 
bw_tree3=list()
bw_tree3_prune <- list()
for( name in names(cycles)) {
  set.seed(501)
  bw_tree3[[name]] <- rpart(factory_cp_level_nc_rate~.,data=cycles[[name]])
  
  bw_tree3_prune[[name]] <- prune(bw_tree3[[name]],cp=     bw_tree3[[name]]$cptable[which.min(bw_tree3[[name]]$cptable[,"xerror"]),"CP"])
  
  
}
 

bw_tree3
fancyRpartPlot(bw_tree3_prune[[1]])
fancyRpartPlot(bw_tree3_prune[[2]])
fancyRpartPlot(bw_tree3_prune[[3]])

```


Establishing a bootstrap sample procedure with condition. 
```{r}

library(tidymodels)
library(glmnet)

temp <- tempDataForest$ximp %>% 
nest(data = -c(Cycle,Country, Cluster)) %>%
mutate(boots = map(data, ~bootstraps(.x, times = 100, apparent = TRUE))) %>%
unnest(boots)

temp <- tempDataForest$ximp %>%
  group_by(Cycle,Country, Cluster) %>%
  group_modify(
    ~ bootstraps(., times = 100, apparent = TRUE)%>%
      mutate(
        model = map(splits, ~ glmnet(factory_cp_level_nc_rate ~ ., data = .)),
        coefs = map(model, tidy)
      )) 


model = map(temp, ~ glmnet(factory_cp_level_nc_rate ~ firm_size, data = .))


temp <- tempDataForest$ximp %>%
nest(data = -c(Cycle,Country, Cluster)) %>%
  mutate(boots = map(data, ~bootstraps(.x, times = 100, apparent = TRUE))) %>%
  unnest(boots)%>%
  mutate(model = map(splits, ~lm(factory_cp_level_nc_rate ~ firm_size+femRatio, data = analysis(.))),
         coef_info = map(model, tidy))

tempDataForest$ximp$Cycle <- as.numeric(as.character(tempDataForest$ximp$Cycle))
tempDataForest$ximp$Factory.Assessed.ID <- as.factor(tempDataForest$ximp$Factory.Assessed.ID)
test<- fold(
  tempDataForest$ximp,
  k = 10,
  cat_col = "Country",
  num_col = "Cycle",
  id_col = "Factory.Assessed.ID"
)

full <- split(test,test$.folds)

sub_countries <- createFolds(countries,list = TRUE, returnTrain = TRUE,k=100)
sub_Cycles <- createFolds(Cycles,list = TRUE, returnTrain = TRUE,k=100)
sub_ID <- createFolds(ID,list = TRUE, returnTrain = TRUE,k=100)
sub_Cluster<- createFolds(Cluster,list = TRUE, returnTrain = TRUE,k=100)
Cluster <- unique(tempDataForest$ximp$Cluster)
countries <- unique(tempDataForest$ximp$Country)
Cycles <- unique(tempDataForest$ximp$Cycle)
ID <- unique(tempDataForest$ximp$Factory.Assessed.ID)
for(i in seq(along = sub_countries)) {
  ## Which subjects are in fold i
 countries_in <- countries[sub_countries[[i]]]
 Cycle_in <- Cycles[sub_Cycles[[i]]]
 ID_in <- Cluster[sub_Cluster[[i]]]
  ## which rows of the data correspond to those subjects
  in_train[[i]] <- row_index[(tempDataForest$ximp$Country %in% countries_in & tempDataForest$ximp$Cycle %in% Cycle_in & tempDataForest$ximp$Cluster %in% ID_in)]
  holdout[[i]]  <- row_index[!(tempDataForest$ximp$Country %in% countries_in & tempDataForest$ximp$Cycle %in% Cycle_in & tempDataForest$ximp$Cluster %in% ID_in)]  
}


ctrl <- trainControl(method = "cv",
                     savePredictions = TRUE,
                     index = in_train,
                     indexOut = holdout)


mod <- train(as.numeric(factory_cp_level_nc_rate) ~ ., data = tempDataForest$ximp[,!(names(tempDataForest$ximp) %in% c("Country","Cluster","Factory.Assessed.ID"))],
             method = "glmnet", 
             trControl = ctrl)
varImportance <- function(data){
    ## Model fitting: ##
  ctrl <- trainControl(method = "cv",
                     savePredictions = TRUE,
                     index = in_train,
                     indexOut = holdout)
   mod <- train(as.numeric(factory_cp_level_nc_rate) ~ ., data = data,
             method = "glmnet", 
             trControl = ctrl)
    varimp <- caret::varImp(mod)
    importance <- t(varimp)
}

cycles <- 10
dt.importance <- as.data.frame(zoo::rollapply(tempDataForest$ximp[,!(names(tempDataForest$ximp) %in% c("Cycle"))], 
                                              FUN = varImportance,
                                              width = 10000,
                                              by.column = FALSE,
                                              align = 'left'))
```

```{r}
library("caTools")
library(caret)
set.seed(501)
c <- which(sample.split( test$`Child Labour`$Country, group =test$.folds))
t <-which(!sample.split( test$`Child Labour`$Country, group =test$.folds))
# train <- c
# test1 <- test[!c,]

set.seed(42)
ximp <- as.data.frame(tempDataForest$ximp)
ximp$trainGen <- NULL
ctrl <- trainControl(method = "timeslice",
                     savePredictions = TRUE,
                     index = c,
                     indexOut = t)

mod <- train(as.numeric(factory_cp_level_nc_rate) ~ ., data =test$`Child Labour`,
             method = "glmnet",
             horizon=3,
             initialWindow = 9,
             trControl = ctrl)



glmnet_ex <- function(data, formula){
  model <- train(formula, data,
                 method = "glmnet",
                 trControl = trainControl(method = "CV"),
                 preProc = c("center","scale"),
                 cluster.seed=500)
  return(model)
 }
 
 
 formula = as.numeric(factory_cp_level_nc_rate)~.
 
 models <- list()
 varIMP <- list()
 for (name in names(test)){
  set.seed(500)
 models[[name]] <- glmnet_ex(test[[name]],formula = formula)
 varIMP[[name]] <- varImp(models[[name]],scale=F)
 }
 
MSE_train <- mean((test$`Child Labour`$factory_cp_level_nc_rate- predict(models$`Child Labour`, newdata = test$`Child Labour`))^2)

pred_names <- names(test$`Child Labour`[,!names(test$`Child Labour`) %in% c("factory_cp_level_nc_rate")])
perm_MSEs_train <- seq(0,length.out=NROW(pred_names))
for ( i in 1:NROW(perm_MSEs_train)) {
  perm_MSEs_train[i] <- NA
  
}

names(perm_MSEs_train) <- pred_names
for (i in pred_names) {
  perm_MSEs_train[i] <- mean((test$y - predict(RF, newdata=test_temp))^2)
  train_temp <- train
  train_temp[ , i] <- sample(train[ , i])
  perm_MSEs_test[i] <- mean((train$y - predict(RF, newdata=train_temp))^2)
}

ximp%>%
  group_split

```

